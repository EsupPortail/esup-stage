<mat-accordion>
  <mat-expansion-panel [expanded]="true">
    <mat-expansion-panel-header>
      Recherchez l'établissement où le stage sera effectué
    </mat-expansion-panel-header>

    <app-table [service]="structureService" [columns]="columns" [sortColumn]="sortColumn" [filters]="filters"
               matSort [matSortActive]="sortColumn" [matSortDirection]="'asc'"
               (matSortChange)="appTable ? appTable.sorting($event) : null" [actionButton]="canCreate() ? createButton : undefined" [selectedRow]="selectedRow">
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="9999">Aucun établissement trouvé</td>
      </tr>
      <ng-container matColumnDef="raisonSociale">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Raison sociale</th>
        <td mat-cell *matCellDef="let row">{{row.raisonSociale}}</td>
      </ng-container>
      <ng-container matColumnDef="numeroSiret">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Numéro SIRET</th>
        <td mat-cell *matCellDef="let row">{{row.numeroSiret}}</td>
      </ng-container>
      <ng-container matColumnDef="nafN5">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Activité</th>
        <td mat-cell *matCellDef="let row">{{row.nafN5 ? row.nafN5.nafN1.libelle : ''}}</td>
      </ng-container>
      <ng-container matColumnDef="pays">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Pays</th>
        <td mat-cell *matCellDef="let row">{{row.pays.lib}}</td>
      </ng-container>
      <ng-container matColumnDef="commune">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Commune</th>
        <td mat-cell *matCellDef="let row">{{row.commune}}</td>
      </ng-container>
      <ng-container matColumnDef="typeStructure">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Type de structure</th>
        <td mat-cell *matCellDef="let row">{{row.typeStructure.libelle}}</td>
      </ng-container>
      <ng-container matColumnDef="statutJuridique">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Forme juridique</th>
        <td mat-cell *matCellDef="let row">{{row.statutJuridique ? row.statutJuridique.libelle : ''}}</td>
      </ng-container>
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
          <button mat-button mat-stroked-button (click)="choose(row)" color="primary">
            <i class="fa fa-check"></i> Sélectionner
          </button>
        </td>
      </ng-container>
    </app-table>
  </mat-expansion-panel>
  <mat-expansion-panel [expanded]="etab" [disabled]="!etab">
    <mat-expansion-panel-header>
      <mat-panel-title>Établissement d'accueil</mat-panel-title>
      <mat-panel-description>
        <div class="w-100 text-right">
          <mat-icon fontSet="fa" fontIcon="fa-building"></mat-icon>
        </div>
      </mat-panel-description>
    </mat-expansion-panel-header>
    <form *ngIf="etab" [formGroup]="form" novalidate (submit)="save()">
      <div class="mt-3 mb-3" *ngIf="etab.id && !modif">
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Raison sociale</div>
          <div class="col-sm-9">{{etab.raisonSociale}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Type d'établissement</div>
          <div class="col-sm-9">{{etab.typeStructure.libelle}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Statut juridique</div>
          <div class="col-sm-9">{{etab.statutJuridique ? etab.statutJuridique.libelle : ''}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Effectif</div>
          <div class="col-sm-9">{{etab.effectif.libelle}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Numéro Siret</div>
          <div class="col-sm-9">{{etab.numeroSiret}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Voie</div>
          <div class="col-sm-9">{{etab.voie}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Code postal</div>
          <div class="col-sm-9">{{etab.codePostal}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Commune</div>
          <div class="col-sm-9">{{etab.commune}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Pays</div>
          <div class="col-sm-9">{{etab.pays.lib}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Téléphone</div>
          <div class="col-sm-9">{{etab.telephone}}</div>
        </div>
        <div class="row">
          <div class="col-sm-3 font-weight-bold">Code APE</div>
          <div class="col-sm-9">{{etab.nafN5 ? (etab.nafN5.code + ' (' + etab.nafN5.libelle + ')') : ''}}</div>
        </div>
      </div>
      <div *ngIf="modif && canEdit()">
        <div class="text-title">Général</div>
        <mat-divider class="mb-2"></mat-divider>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Raison sociale</mat-label>
            <input matInput formControlName="raisonSociale" required />
            <mat-icon matSuffix class="icon-help" matTooltip="Nom de l'organisme">help</mat-icon>
            <mat-error><app-form-error [field]="form.get('raisonSociale')"></app-form-error></mat-error>
          </mat-form-field>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Numéro Siret</mat-label>
            <input matInput formControlName="numeroSiret" required />
            <mat-icon matSuffix class="icon-help" matTooltip="Code INSEE à demander à votre établissement d'accueil ou consultable sur des sites de référencement d'entreprises. Correspond à l'identifiant géographique de l'établissement. (format : 14 chiffres consécutifs sans espace - ex: 12345678912345)">help</mat-icon>
            <mat-error><app-form-error [field]="form.get('numeroSiret')"></app-form-error></mat-error>
          </mat-form-field>
        </div>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Effectif</mat-label>
            <mat-select formControlName="idEffectif" required>
              <mat-option *ngFor="let effectif of effectifs" [value]="effectif.id">{{effectif.libelle}}</mat-option>
            </mat-select>
            <mat-error><app-form-error [field]="form.get('idEffectif')"></app-form-error></mat-error>
          </mat-form-field>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Type d'établissement</mat-label>
            <mat-select formControlName="idTypeStructure" required>
              <mat-option *ngFor="let typeStructure of typeStructures" [value]="typeStructure.id">{{typeStructure.libelle}}</mat-option>
            </mat-select>
            <mat-error><app-form-error [field]="form.get('idTypeStructure')"></app-form-error></mat-error>
          </mat-form-field>
        </div>
        <div class="row">
          <div class="col-sm-12 col-md-6 mb-2"></div>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Statut juridique</mat-label>
            <mat-select formControlName="idStatutJuridique" required>
              <mat-option *ngFor="let statutJuridique of statutJuridiques" [value]="statutJuridique.id">{{statutJuridique.libelle}}</mat-option>
            </mat-select>
            <mat-error><app-form-error [field]="form.get('idStatutJuridique')"></app-form-error></mat-error>
          </mat-form-field>
        </div>

        <div class="text-title">Activité</div>
        <mat-divider class="mb-2"></mat-divider>
        <div class="alert alert-info text-center">
          Une de ces deux informations doit être renseignée.
        </div>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Code APE</mat-label>
            <input matInput formControlName="codeNafN5" (change)="getNafN5()" />
            <mat-icon matSuffix class="icon-help" matTooltip="Code à demander directement à votre établissement d'accueil ou consultable sur un site de référencement d'entreprises. Composé de quatre chiffres et une lettre (ex: 01.10Z) faisant référence à la nomenclature d'activité françaises (NAF).">help</mat-icon>
            <mat-hint>
              <ng-container *ngIf="selectedNafN5; else invalidNafN5">
                <span class="text-success"><i class="fa fa-check"></i> {{selectedNafN5.libelle}}</span>
              </ng-container>
              <ng-template #invalidNafN5>
                <span class="text-danger" *ngIf="selectedNafN5 !== undefined">Ce code est invalide</span>
              </ng-template>
            </mat-hint>
          </mat-form-field>
          <div class="col-sm-12 col-md-6 mb-2">
            <label>Activité principale</label>
            <quill-editor formControlName="activitePrincipale"></quill-editor>
          </div>
        </div>

        <div class="text-title">Coordonnées</div>
        <mat-divider class="mb-2"></mat-divider>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Voie</mat-label>
            <input matInput formControlName="voie" required />
            <mat-error><app-form-error [field]="form.get('voie')"></app-form-error></mat-error>
          </mat-form-field>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Code postal</mat-label>
            <input matInput formControlName="codePostal" required />
            <mat-error><app-form-error [field]="form.get('codePostal')"></app-form-error></mat-error>
          </mat-form-field>
        </div>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Bâtiment / Résidence / Z.I</mat-label>
            <input matInput formControlName="batimentResidence" />
          </mat-form-field>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Commune</mat-label>
            <input matInput formControlName="commune" required />
            <mat-error><app-form-error [field]="form.get('commune')"></app-form-error></mat-error>
          </mat-form-field>
        </div>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Libellé Cedex ou Localité de destination</mat-label>
            <input matInput formControlName="libCedex" />
          </mat-form-field>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Pays</mat-label>
            <mat-select formControlName="idPays" required>
              <mat-option *ngFor="let country of countries" [value]="country.id">{{country.libelle}}</mat-option>
            </mat-select>
            <mat-error><app-form-error [field]="form.get('idPays')"></app-form-error></mat-error>
          </mat-form-field>
        </div>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Adresse mail</mat-label>
            <input type="email" matInput formControlName="mail" />
            <mat-hint>Sous cette forme adresse@domain.fr</mat-hint>
            <mat-error><app-form-error [field]="form.get('email')"></app-form-error></mat-error>
          </mat-form-field>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Téléphone</mat-label>
            <input matInput formControlName="telephone" required />
            <mat-error><app-form-error [field]="form.get('telephone')"></app-form-error></mat-error>
          </mat-form-field>
        </div>
        <div class="row">
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Site internet</mat-label>
            <input type="url" matInput formControlName="siteWeb" />
            <mat-hint>Sous cette forme http://siteinternet.fr/...</mat-hint>
            <mat-error><app-form-error [field]="form.get('siteWeb')"></app-form-error></mat-error>
          </mat-form-field>
          <mat-form-field class="col-sm-12 col-md-6 mb-2" appearance="fill">
            <mat-label>Fax</mat-label>
            <input matInput formControlName="fax" />
          </mat-form-field>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-sm-6" *ngIf="canEdit()">
          <button mat-button mat-stroked-button color="primary" *ngIf="etab.id && !modif" (click)="edit()">Modifier ces informations</button>
          <button mat-button mat-stroked-button color="warn" *ngIf="etab.id && modif" (click)="cancelEdit()">{{'BOUTON_ANNULER'|contenu}}</button>
        </div>
        <div class="col-sm-6 text-right" *ngIf="(canEdit() || canCreate()) && modif">
          <button mat-button mat-flat-button color="primary">{{'BOUTON_VALIDER'|contenu}}</button>
        </div>
      </div>
    </form>
  </mat-expansion-panel>
</mat-accordion>
