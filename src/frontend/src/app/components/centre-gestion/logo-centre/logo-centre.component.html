<mat-card>
  <mat-card-content>
    <p>Le logo est utilisé lors de l'impression des conventions, des avenants et des offres de stage et d'emploi.</p>
    <p>Ce centre de gestion possède un critère de gestion de type {{centreGestion.niveauCentre.libelle}}</p>
    <p>Le logo du centre de gestion au niveau ETABLISSEMENT sera également imprimé sur les conventions.</p>

    <div class="import-info-box">
      <div class="import-info-title">
        <mat-icon color="info">info</mat-icon>
        <span class="m-2">Recommendations pour un résultat optimal</span>
      </div>

      <div class="import-info-details">
        <ul>
          <li>Pour un logo rectangulaire : 320 × 160 px minimum</li>
          <li>Pour un logo carré : 160 × 160 px minimum</li>
          <li>Format PNG ou SVG avec fond transparent</li>
        </ul>
      </div>
    </div>

    <mat-card-actions class="text-center">
      <button class="action-bt" mat-stroked-button color="primary" (click)="logoInput.click()">
        <span>{{currentFile && currentFile.size > 0 ? 'Changer de logo' : 'Insérer un logo'}}</span>
        <input #logoInput type="file" (change)="onLogoChange($event)" accept="image/*" style="display:none">
      </button>

      <button class="action-bt" mat-stroked-button color="warn" (click)="removeLogo()"
              *ngIf="currentFile && currentFile.size > 0">
        Supprimer le logo
      </button>
    </mat-card-actions>

    <!-- Zone de recadrage -->
    <div *ngIf="imageChangedEvent" class="cropper-section">
      <h3>Recadrer votre image</h3>

      <image-cropper
        [imageChangedEvent]="imageChangedEvent"
        [maintainAspectRatio]="false"
        [cropperMinWidth]="100"
        [cropperMinHeight]="100"
        [resizeToWidth]="600"
        [format]="outputFormat"
        [roundCropper]="false"
        (imageCropped)="imageCropped($event)"
        (loadImageFailed)="loadImageFailed()">
      </image-cropper>

      <!-- Aperçu de l'image recadrée -->
      <div *ngIf="croppedImage" class="preview-container">
        <h4>Aperçu :</h4>
        <img [src]="croppedImage" alt="Logo recadré" class="preview-image"
             style="max-width: 300px; max-height: 300px;" />
      </div>

      <!-- Boutons d'action -->
      <div class="cropper-actions" style="margin-top: 15px;">
        <button mat-raised-button color="primary" (click)="uploadCroppedLogo()"
                [disabled]="!croppedBlob">
          Valider et enregistrer
        </button>
        <button mat-stroked-button color="warn" (click)="cancelCrop()"
                style="margin-left: 10px;">
          Annuler
        </button>
      </div>
    </div>

    <!-- Aperçu du logo actuel -->
    <div *ngIf="previewUrl && !imageChangedEvent" class="current-logo-preview">
      <div class="preview-container">
        <img [src]="previewUrl" alt="Preview du logo" class="preview-image"
             style="max-width: 300px; max-height: 300px;" />
      </div>
    </div>

    <!-- Sélecteur de template -->
    <mat-form-field appearance="outline" class="w-100">
      <mat-label>Template de convention</mat-label>
      <mat-select [formControl]="templateCtrl">
        <mat-option [value]="null">-- Sélectionner --</mat-option>
        <mat-option *ngFor="let t of templateConvention" [value]="t.id">
          {{ t.displayLabel }}
        </mat-option>
      </mat-select>
      <mat-hint>Sélectionnez un template (type + langue) pour générer l’aperçu PDF après enregistrement du logo.</mat-hint>
    </mat-form-field>

    <!-- ========== SECTION PREVIEW PDF (auto, pas de bouton) ========== -->
    <div *ngIf="showPdfPreview" class="pdf-preview-section">
      <mat-card class="pdf-preview-card">
        <mat-card-header class="pdf-preview-header">
          <mat-card-title>
            <mat-icon>description</mat-icon>
            Aperçu de la convention (données fictives)
          </mat-card-title>
          <button mat-icon-button
                  (click)="refreshPdfPreview()"
                  [disabled]="pdfLoading"
                  matTooltip="Rafraîchir l'aperçu">
            <mat-icon>refresh</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content class="pdf-preview-content">
          <!-- État de chargement -->
          <div *ngIf="pdfLoading" class="pdf-loading">
            <mat-spinner diameter="50"></mat-spinner>
            <p>Génération de l'aperçu de la convention...</p>
          </div>

          <!-- Erreur -->
          <div *ngIf="pdfError && !pdfLoading" class="pdf-error">
            <mat-icon color="warn">error_outline</mat-icon>
            <p>{{ pdfError }}</p>
            <button mat-stroked-button color="primary" (click)="refreshPdfPreview()">
              Réessayer
            </button>
          </div>

          <!-- Affichage du PDF -->
          <iframe
            *ngIf="pdfUrl && !pdfLoading && !pdfError"
            [attr.src]="pdfUrl"
            type="application/pdf"
            class="pdf-viewer"
            frameborder="0"
            title="Aperçu de la convention">
          </iframe>

          <!-- Message lorsqu'un template est sélectionné mais que la preview n'a pas encore été générée -->
          <div *ngIf="!pdfUrl && !pdfLoading && !pdfError">
            <p>Sélectionnez un template puis enregistrez (ou supprimez) un logo pour générer l’aperçu.</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-card-content>
</mat-card>
