<div class="questionnaire-container">
  <div id="page-top"></div>

  <form [formGroup]="reponseEntrepriseForm" novalidate *ngIf="ficheEvaluation" class="conteneur-questionnaire-tuteur">
    <mat-tab-group [(selectedIndex)]="selectedTab">

      <!-- TAB 1 : Savoir-être -->
      <mat-tab class="tab-content" label="Savoir être du stagiaire">
        <div class="mt-2 mb-2" *ngFor="let q of FicheEntrepriseIQuestions">
          <div *ngIf="ficheEvaluation[toLegacyQuestionKey(q.code)]">

            <div class="mb-2"><b>{{ q.texte }}</b></div>

            <ng-container [ngSwitch]="q.type">

              <!-- LIKERT 5 -->
              <mat-radio-group *ngSwitchCase="TypeQuestionEvaluation.SCALE_LIKERT_5"
                               class="radio-grid"
                               [formControlName]="toControlBase(q.code)">
                <mat-radio-button class="radio-item"
                                  *ngFor="let opt of q.options; let i = index"
                                  [value]="i">
                  {{ opt }}
                </mat-radio-button>
              </mat-radio-group>

              <!-- YES/NO (au cas où) -->
              <mat-radio-group *ngSwitchCase="TypeQuestionEvaluation.YES_NO"
                               [formControlName]="toControlBase(q.code)">
                <mat-radio-button [value]="true">Oui</mat-radio-button>
                <mat-radio-button [value]="false">Non</mat-radio-button>
              </mat-radio-group>

              <!-- TEXTE (rare ici) -->
              <div *ngSwitchCase="TypeQuestionEvaluation.TEXT">
                <mat-form-field appearance="fill" style="width:100%">
                  <textarea matInput [formControlName]="toControlBase(q.code)"></textarea>
                </mat-form-field>
              </div>
            </ng-container>

            <!-- BLOC BIS -->
            <div class="col-md-12 mt-2 mb-2" *ngIf="shouldShowBis(q)">
              <div class="mb-2"><b>{{ q.bisQuestion }}</b></div>
              <mat-form-field appearance="fill" style="width:100%">
                <textarea matInput [formControlName]="toControlBase(q.code) + 'bis'"></textarea>
              </mat-form-field>
            </div>
          </div>
        </div>

        <!-- Questions supplémentaires (bloc 5) -->
        <ng-container *ngIf="questionsSupplementaires?.[5]?.length">
          <mat-divider class="mt-2 mb-2"></mat-divider>
          <ng-container [formGroup]="reponseSupplementaireEntrepriseForm">
            <div class="mt-2 mb-2" *ngFor="let qs of questionsSupplementaires[5]">
              <div class="mb-2"><b>{{ qs.question }}</b></div>

              <mat-form-field style="width:100%" appearance="fill" *ngIf="qs.typeQuestion === 'txt'">
                <textarea matInput [formControlName]="qs.formControlName"></textarea>
              </mat-form-field>

              <mat-radio-group class="radio-grid" *ngIf="qs.typeQuestion === 'not'"
                               [formControlName]="qs.formControlName">
                <mat-radio-button class="radio-item" [value]="0">Excellent</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="1">Très bien</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="2">Bien</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="3">Satisfaisant</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="4">Insuffisant</mat-radio-button>
              </mat-radio-group>

              <mat-radio-group *ngIf="qs.typeQuestion === 'yn'"
                               [formControlName]="qs.formControlName">
                <mat-radio-button [value]="true">Oui</mat-radio-button>
                <mat-radio-button [value]="false">Non</mat-radio-button>
              </mat-radio-group>
            </div>
          </ng-container>
        </ng-container>
      </mat-tab>

      <!-- TAB 2 : Savoir-faire -->
      <mat-tab class="tab-content" label="Savoir faire du stagiaire">
        <div class="mt-2 mb-2" *ngFor="let q of FicheEntrepriseIIQuestions">
          <div *ngIf="ficheEvaluation[toLegacyQuestionKey(q.code)]">

            <div class="mb-2"><b>{{ q.texte }}</b></div>

            <ng-container [ngSwitch]="q.type">

              <mat-radio-group *ngSwitchCase="TypeQuestionEvaluation.SCALE_LIKERT_5"
                               class="radio-grid"
                               [formControlName]="toControlBase(q.code)">
                <mat-radio-button class="radio-item"
                                  *ngFor="let opt of q.options; let i = index"
                                  [value]="i">
                  {{ opt }}
                </mat-radio-button>
              </mat-radio-group>

              <mat-radio-group *ngSwitchCase="TypeQuestionEvaluation.YES_NO"
                               [formControlName]="toControlBase(q.code)">
                <mat-radio-button [value]="true">Oui</mat-radio-button>
                <mat-radio-button [value]="false">Non</mat-radio-button>
              </mat-radio-group>

              <div *ngSwitchCase="TypeQuestionEvaluation.TEXT">
                <mat-form-field appearance="fill" style="width:100%">
                  <textarea matInput [formControlName]="toControlBase(q.code)"></textarea>
                </mat-form-field>
              </div>
            </ng-container>

            <div class="col-md-12 mt-2 mb-2" *ngIf="shouldShowBis(q)">
              <div class="mb-2"><b>{{ q.bisQuestion }}</b></div>
              <mat-form-field appearance="fill" style="width:100%">
                <textarea matInput [formControlName]="toControlBase(q.code) + 'bis'"></textarea>
              </mat-form-field>
            </div>
          </div>
        </div>

        <!-- Questions supplémentaires (bloc 6) -->
        <ng-container *ngIf="questionsSupplementaires?.[6]?.length">
          <mat-divider class="mt-2 mb-2"></mat-divider>
          <ng-container [formGroup]="reponseSupplementaireEntrepriseForm">
            <div class="mt-2 mb-2" *ngFor="let qs of questionsSupplementaires[6]">
              <div class="mb-2"><b>{{ qs.question }}</b></div>

              <mat-form-field style="width:100%" appearance="fill" *ngIf="qs.typeQuestion === 'txt'">
                <textarea matInput [formControlName]="qs.formControlName"></textarea>
              </mat-form-field>

              <mat-radio-group class="radio-grid" *ngIf="qs.typeQuestion === 'not'"
                               [formControlName]="qs.formControlName">
                <mat-radio-button class="radio-item" [value]="0">Excellent</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="1">Très bien</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="2">Bien</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="3">Satisfaisant</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="4">Insuffisant</mat-radio-button>
              </mat-radio-group>

              <mat-radio-group *ngIf="qs.typeQuestion === 'yn'"
                               [formControlName]="qs.formControlName">
                <mat-radio-button [value]="true">Oui</mat-radio-button>
                <mat-radio-button [value]="false">Non</mat-radio-button>
              </mat-radio-group>
            </div>
          </ng-container>
        </ng-container>
      </mat-tab>

      <!-- TAB 3 : Appréciation générale -->
      <mat-tab class="tab-content" label="Appréciation générale du stage">
        <div class="mt-2 mb-2" *ngFor="let q of FicheEntrepriseIIIQuestions">
          <div *ngIf="ficheEvaluation[toLegacyQuestionKey(q.code)]">

            <div class="mb-2"><b>{{ q.texte }}</b></div>

            <ng-container [ngSwitch]="q.type">

              <mat-radio-group *ngSwitchCase="TypeQuestionEvaluation.SCALE_AGREEMENT_5"
                               class="radio-grid"
                               [formControlName]="toControlBase(q.code)">
                <mat-radio-button class="radio-item"
                                  *ngFor="let opt of q.options; let i = index"
                                  [value]="i">
                  {{ opt }}
                </mat-radio-button>
              </mat-radio-group>

              <mat-radio-group *ngSwitchCase="TypeQuestionEvaluation.SCALE_LIKERT_5"
                               class="radio-grid"
                               [formControlName]="toControlBase(q.code)">
                <mat-radio-button class="radio-item"
                                  *ngFor="let opt of q.options; let i = index"
                                  [value]="i">
                  {{ opt }}
                </mat-radio-button>
              </mat-radio-group>

              <mat-radio-group *ngSwitchCase="TypeQuestionEvaluation.YES_NO"
                               [formControlName]="toControlBase(q.code)">
                <mat-radio-button [value]="true">Oui</mat-radio-button>
                <mat-radio-button [value]="false">Non</mat-radio-button>
              </mat-radio-group>

              <div *ngSwitchCase="TypeQuestionEvaluation.TEXT">
                <mat-form-field appearance="fill" style="width:100%">
                  <textarea matInput [formControlName]="toControlBase(q.code)"></textarea>
                </mat-form-field>
              </div>
            </ng-container>

            <div class="col-md-12 mt-2 mb-2" *ngIf="shouldShowBis(q)">
              <div class="mb-2"><b>{{ q.bisQuestion }}</b></div>
              <mat-form-field appearance="fill" style="width:100%">
                <textarea matInput [formControlName]="toControlBase(q.code) + 'bis'"></textarea>
              </mat-form-field>
            </div>
          </div>
        </div>

        <!-- Questions supplémentaires (bloc 7) -->
        <ng-container *ngIf="questionsSupplementaires?.[7]?.length">
          <mat-divider class="mt-2 mb-2"></mat-divider>
          <ng-container [formGroup]="reponseSupplementaireEntrepriseForm">
            <div class="mt-2 mb-2" *ngFor="let qs of questionsSupplementaires[7]">
              <div class="mb-2"><b>{{ qs.question }}</b></div>

              <mat-form-field style="width:100%" appearance="fill" *ngIf="qs.typeQuestion === 'txt'">
                <textarea matInput [formControlName]="qs.formControlName"></textarea>
              </mat-form-field>

              <mat-radio-group class="radio-grid" *ngIf="qs.typeQuestion === 'not'"
                               [formControlName]="qs.formControlName">
                <mat-radio-button class="radio-item" [value]="0">Excellent</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="1">Très bien</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="2">Bien</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="3">Satisfaisant</mat-radio-button>
                <mat-radio-button class="radio-item" [value]="4">Insuffisant</mat-radio-button>
              </mat-radio-group>

              <mat-radio-group *ngIf="qs.typeQuestion === 'yn'"
                               [formControlName]="qs.formControlName">
                <mat-radio-button [value]="true">Oui</mat-radio-button>
                <mat-radio-button [value]="false">Non</mat-radio-button>
              </mat-radio-group>
            </div>
          </ng-container>
        </ng-container>
      </mat-tab>
    </mat-tab-group>
  </form>

  <div class="btn-container">
    <button class="valid-button" mat-raised-button (click)="enregistrer()">
      <mat-icon aria-hidden="true">save</mat-icon>
      Enregistrer
    </button>
  </div>
</div>

<div class="btn-container">
  <button class="valid-button" mat-stroked-button (click)="prevTab()" [disabled]="selectedTab === 0">
    <span class="fas fa-chevron-left me-2" aria-hidden="true"></span> Précédent
  </button>

  <ng-container *ngIf="!isLastTab; else endBtn">
    <button class="valid-button" mat-stroked-button (click)="nextOrFinish()">
      Suivant <span class="fas fa-chevron-right ms-2" aria-hidden="true"></span>
    </button>
  </ng-container>

  <ng-template #endBtn>
    <span
      (confirm)="nextOrFinish()"
      [preset]="(reponseEntrepriseForm.valid && reponseSupplementaireEntrepriseForm.valid) ? 'success' : 'warning'"
      [confirmMessage]="(reponseEntrepriseForm.valid && reponseSupplementaireEntrepriseForm.valid)
        ? 'Tout est rempli. Valider définitivement ?'
        : 'Certaines réponses manquent. Valider quand même ?'">
      <button class="valid-button" mat-raised-button>Terminer</button>
    </span>
  </ng-template>
</div>
