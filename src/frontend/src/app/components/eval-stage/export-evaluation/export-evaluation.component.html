<div class="modal-overlay">
  <div class="modal-container">
    <div class="header-banner">
      <h1>Exporter</h1>
    </div>

    <div class="column-selector-dialog">
      <!-- Choix type fiche -->
      <div class="type-eval-form" [formGroup]="form">
        <div class="radio-block" role="group" aria-label="Choix du types d'évaluation">
          <label class="block-label">Types d'évaluation : </label>
          <mat-radio-group formControlName="typeFiche">
            <mat-radio-button [value]="0">Étudiant</mat-radio-button>
            <mat-radio-button [value]="1">Enseignant référent</mat-radio-button>
            <mat-radio-button [value]="2">Tuteur professionnel</mat-radio-button>
            <mat-radio-button [value]="3">Toutes les évaluations</mat-radio-button>
          </mat-radio-group>
        </div>
      </div>

      <!-- Info quand non choisi -->
      <div *ngIf="isLocked" style="margin-top:8px;">
        Sélectionnez d’abord un type d’évaluation pour gérer les colonnes.
      </div>

      <!-- Gestion des colonnes : visible seulement si au moins une feuille à afficher -->
      <div class="column-selector-dialog" *ngIf="!isLocked && displayedSheets.length">
        <div class="column-selector-title">Choix des colonnes à exporter :</div>

        <mat-tab-group *ngIf="displayedSheets.length > 1" [(selectedIndex)]="selectedSheetIndex">
          <mat-tab *ngFor="let sheet of displayedSheets" [label]="sheet.title"></mat-tab>
        </mat-tab-group>

        <div class="column-selector-scrollable" *ngIf="currentSheet">
          <div class="column-selector-container">

            <!-- DISPONIBLES -->
            <div class="column-list"
                 cdkDropList
                 #availableList="cdkDropList"
                 [cdkDropListDisabled]="isLocked"
                 [cdkDropListData]="currentSheet.availableColumns"
                 [cdkDropListConnectedTo]="[selectedList]"
                 (cdkDropListDropped)="drop($event, currentSheet)">

              <div class="list-header">
                <div class="list-title">
                  <mat-checkbox
                    [disabled]="isLocked"
                    [checked]="isAllAvailableSelected(currentSheet)"
                    (change)="toggleAllAvailable($event.checked, currentSheet)">
                  </mat-checkbox>
                  Colonnes disponibles
                </div>
              </div>

              <div class="list">
                <div class="list-item"
                     *ngFor="let col of currentSheet.availableColumns; trackBy: trackByKey"
                     cdkDrag
                     [cdkDragDisabled]="isLocked"
                     [cdkDragData]="col"
                     [class.selected]="selectedAvailableKeys.has(col.key)"
                     (click)="!isLocked && toggleAvailable(col)">
                  {{ col.title }}
                </div>
              </div>
            </div>

            <!-- ACTIONS -->
            <div class="column-actions">
              <button mat-icon-button
                      (click)="addSelected(currentSheet)"
                      [disabled]="isLocked || !selectedAvailableKeys.size">
                <mat-icon aria-hidden="true">arrow_forward</mat-icon>
              </button>
              <button mat-icon-button
                      (click)="removeSelected(currentSheet)"
                      [disabled]="isLocked || !selectedChosenKeys.size">
                <mat-icon aria-hidden="true">arrow_back</mat-icon>
              </button>
            </div>

            <!-- SELECTIONNÉES -->
            <div class="column-list"
                 cdkDropList
                 #selectedList="cdkDropList"
                 [cdkDropListDisabled]="isLocked"
                 [cdkDropListData]="currentSheet.selectedColumns"
                 [cdkDropListConnectedTo]="[availableList]"
                 (cdkDropListDropped)="drop($event, currentSheet)">

              <div class="list-header">
                <div class="list-title">
                  <mat-checkbox
                    [disabled]="isLocked"
                    [checked]="isAllChosenSelected(currentSheet)"
                    (change)="toggleAllChosen($event.checked, currentSheet)">
                  </mat-checkbox>
                  Colonnes sélectionnées
                </div>
              </div>

              <div class="list">
                <div class="list-item"
                     *ngFor="let col of currentSheet.selectedColumns; trackBy: trackByKey"
                     cdkDrag
                     [cdkDragDisabled]="isLocked"
                     [cdkDragData]="col"
                     [class.selected]="selectedChosenKeys.has(col.key)"
                     (click)="!isLocked && toggleChosen(col)">
                  {{ col.title }}
                </div>
              </div>
            </div>

          </div>
        </div>
        <div class="reset-btn">
          <button class="cancel-button" mat-stroked-button (click)="reset(null)" [disabled]="isLocked">Réinitialiser</button>
        </div>
      </div>

      <div class="actions">
        <button class="cancel-button" mat-flat-button (click)="cancel()">Annuler</button>

        <span [matTooltip]="'Veuillez d\'abord renseigner le type d\'évaluation'"
              [matTooltipDisabled]="form.valid"
              matTooltipPosition="above"
              [tabindex]="form.valid ? -1 : 0">
          <button class="valid-button" mat-flat-button [disabled]="!form.valid" (click)="confirm()">Valider</button>
        </span>
      </div>
    </div>
  </div>
</div>
